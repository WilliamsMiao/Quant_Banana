# 交易执行逻辑分析

## 当前流程

### 1. 策略轮询
- **频率**: 每 2 秒轮询一次（`pull_interval_sec=2.0`）
- **操作**: 
  - 获取最新K线数据
  - 调用 `strategy.on_market_data(df)`
  - 处理信号 `_handle_signals(strategy)`

### 2. 信号生成
- **触发条件**: 每次 `on_market_data` 调用时，如果满足策略条件就生成信号
- **去重机制**: 基于 `(symbol, action, timestamp)` 去重
- **问题**: 每根新K线的 timestamp 不同，所以可能每2秒都生成信号

### 3. AI决策生成
- **触发**: 收到策略信号后
- **去重**: 30秒内相同 `(symbol, action, timestamp)` 不重复处理
- **问题**: 30秒后如果又有新信号，就会再次生成AI决策

### 4. 下单执行
- **触发条件**: AI决策为"执行交易"
- **无冷却期**: 每次决策都会尝试下单
- **问题**: 如果策略频繁生成信号（每2秒），即使有30秒AI去重，也可能在30秒后再次下单

## 发现的问题

1. **下单过于频繁**: 缺少对同一标的、同一方向的订单冷却期
2. **信号生成频繁**: 策略可能在每根新K线都生成信号（即使价格没变多少）
3. **缺少频率控制**: 虽然有30秒AI去重，但没有订单级别的冷却期

## 建议的修复

1. **添加下单冷却期**: 同一标的、同一方向，5分钟内不重复下单
2. **改进信号生成**: 策略应该只在突破时才生成信号，而不是每根K线
3. **添加订单状态追踪**: 记录最近的订单，避免重复下单


